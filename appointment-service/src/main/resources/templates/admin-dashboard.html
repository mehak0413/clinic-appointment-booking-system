<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/head :: commonHead('Admin Dashboard')}"></head>
  <body class="bg-gray-100">
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <div class="ml-64 p-6">
      <!-- Header -->
      <div th:replace="~{fragments/header :: header('Admin Dashboard')}"></div>

      <!-- Dashboard Cards -->
      <div class="grid grid-cols-3 gap-6 mt-6">
        <div
          th:replace="~{fragments/cards :: card('Total Doctors', ${totalDoctors})}"
        ></div>
        <div
          th:replace="~{fragments/cards :: card('Total Patients', ${totalPatients})}"
        ></div>
        <div
          th:replace="~{fragments/cards :: card('Appointments Today', ${appointmentsToday})}"
        ></div>
      </div>

      <div
        id="appointmentsTable"
        class="mt-8 bg-white p-6 rounded-2xl shadow-md"
      >
        <h3 class="font-semibold mb-2">All Appointments</h3>
        <table class="w-full border-collapse">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2">Patient</th>
              <th class="px-3 py-2">Doctor</th>
              <th class="px-3 py-2">Date/Time</th>
              <th class="px-3 py-2">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr
              th:each="appt : ${allAppointments}"
              class="border-b hover:bg-gray-50"
            >
              <td th:text="${appt.patient.name}"></td>
              <td th:text="${appt.doctor.name}"></td>
              <td
                th:text="${#temporals.format(appt.appointmentTime,'dd/MM/yyyy HH:mm')}"
              ></td>
              <td th:text="${appt.status}"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Tabs -->
      <div class="mt-8 bg-white p-6 rounded-2xl shadow-md">
        <h2 class="text-xl font-bold mb-4">Manage Entities</h2>

        <div class="flex gap-4 mb-4">
          <button
            class="px-4 py-2 bg-blue-500 text-white rounded"
            onclick="showTab('doctors')"
          >
            Doctors
          </button>
          <button
            class="px-4 py-2 bg-green-500 text-white rounded"
            onclick="showTab('patients')"
          >
            Patients
          </button>
          <button
            class="px-4 py-2 bg-purple-500 text-white rounded"
            onclick="showTab('appointments')"
          >
            Appointments
          </button>
        </div>

        <!-- Doctors Tab -->
        <div id="doctors" class="tab-content">
          <table class="w-full border-collapse">
            <thead class="bg-gray-100">
              <tr class="border-b">
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Name
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Email
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Specialization
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Role
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                th:each="doc : ${allDoctors}"
                class="border-b hover:bg-gray-50"
              >
                <td th:text="${doc.name}" class="py-3 px-4"></td>
                <td th:text="${doc.email}" class="py-3 px-4"></td>
                <td th:text="${doc.specialization}" class="py-3 px-4"></td>
                <td th:text="${doc.role}" class="py-3 px-4"></td>
                <td class="py-3 px-4 flex gap-2">
                  <button
                    class="bg-yellow-400 text-white px-2 py-1 rounded"
                    th:onclick="|showDoctorModal(${doc.id})|"
                  >
                    Edit
                  </button>
                  <button
                    class="bg-red-500 text-white px-2 py-1 rounded"
                    th:onclick="|deleteDoctor(${doc.id})|"
                  >
                    Delete
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Patients Tab -->
        <div id="patients" class="tab-content hidden">
          <table class="w-full border-collapse">
            <thead class="bg-gray-100">
              <tr class="border-b">
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Name
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Email
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Role
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                th:each="pat : ${allPatients}"
                class="border-b hover:bg-gray-50"
              >
                <td th:text="${pat.name}" class="py-3 px-4"></td>
                <td th:text="${pat.email}" class="py-3 px-4"></td>
                <td th:text="${pat.role}" class="py-3 px-4"></td>
                <td class="py-3 px-4 flex gap-2">
                  <button
                    class="bg-yellow-400 text-white px-2 py-1 rounded"
                    th:onclick="|showPatientModal(${pat.id})|"
                  >
                    Edit
                  </button>
                  <button
                    class="bg-red-500 text-white px-2 py-1 rounded"
                    th:onclick="|deletePatient(${pat.id})|"
                  >
                    Delete
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Appointments Tab -->
        <div id="appointments" class="tab-content hidden">
          <h3 class="font-semibold mb-2 flex justify-between items-center">
            Appointments
          </h3>
          <table class="w-full border-collapse">
            <thead class="bg-gray-100">
              <tr class="border-b">
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Patient
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Doctor
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Date/Time
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Status
                </th>
                <th class="py-3 px-4 text-left font-medium text-gray-700">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                th:each="appt : ${allAppointments}"
                class="border-b hover:bg-gray-50"
              >
                <td th:text="${appt.patient.name}" class="py-3 px-4"></td>
                <td th:text="${appt.doctor.name}" class="py-3 px-4"></td>
                <td
                  th:text="${#temporals.format(appt.appointmentTime,'dd/MM/yyyy HH:mm')}"
                  class="py-3 px-4"
                ></td>
                <td th:text="${appt.status}" class="py-3 px-4"></td>
                <td class="py-3 px-4 flex gap-2">
                  <button
                    class="bg-yellow-400 text-white px-2 py-1 rounded"
                    th:onclick="|showAppointmentModal(${appt.id})|"
                  >
                    Edit
                  </button>
                  <button
                    class="bg-red-500 text-white px-2 py-1 rounded"
                    th:onclick="|deleteAppointment(${appt.id})|"
                  >
                    Delete
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- DOCTOR MODAL -->
      <div
        id="doctorModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
      >
        <div class="bg-white p-6 rounded-xl w-96">
          <h2 id="doctorModalTitle" class="text-xl font-bold mb-4">
            Add Doctor
          </h2>
          <form id="doctorForm">
            <input type="hidden" id="doctorId" name="id" />

            <label class="block mb-2">Name</label>
            <input
              type="text"
              name="name"
              id="doctorName"
              class="w-full border px-3 py-2 rounded mb-3"
              required
            />

            <label class="block mb-2">Email</label>
            <input
              type="email"
              name="email"
              id="doctorEmail"
              class="w-full border px-3 py-2 rounded mb-3"
              required
            />

            <label class="block mb-2">Specialization</label>
            <input
              type="text"
              name="specialization"
              id="doctorSpec"
              class="w-full border px-3 py-2 rounded mb-3"
              required
            />

            <div class="flex justify-end gap-3">
              <button
                type="button"
                onclick="closeDoctorModal()"
                class="px-4 py-2 bg-gray-400 text-white rounded"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded"
              >
                Save
              </button>
              <button
                type="button"
                id="doctorDeleteBtn"
                onclick="deleteDoctor()"
                class="px-4 py-2 bg-red-600 text-white rounded hidden"
              >
                Delete
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- PATIENT MODAL -->
      <div
        id="patientModal"
        class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden"
      >
        <div class="bg-white p-6 rounded shadow-lg w-1/3">
          <h2 id="patientModalTitle" class="text-xl font-semibold mb-4">
            Add Patient
          </h2>

          <form id="patientForm" method="post" class="space-y-4">
            <input type="hidden" id="patientId" name="id" />

            <div>
              <label
                for="patientName"
                class="block text-sm font-medium text-gray-700"
                >Name</label
              >
              <input
                type="text"
                id="patientName"
                name="name"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                required
              />
            </div>

            <div>
              <label
                for="patientEmail"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="patientEmail"
                name="email"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                required
              />
            </div>

            <div>
              <label
                for="patientRole"
                class="block text-sm font-medium text-gray-700"
                >Role</label
              >
              <input
                type="text"
                id="patientRole"
                name="role"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                required
              />
            </div>

            <div>
              <label
                for="patientPassword"
                class="block text-sm font-medium text-gray-700"
                >Password</label
              >
              <input
                type="password"
                id="patientPassword"
                name="password"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                placeholder="Leave blank to keep unchanged"
              />
            </div>

            <div class="flex justify-between">
              <button
                type="submit"
                class="bg-blue-500 text-white px-4 py-2 rounded"
              >
                Save
              </button>
              <button
                type="button"
                id="patientDeleteBtn"
                class="bg-red-500 text-white px-4 py-2 rounded hidden"
              >
                Delete
              </button>
              <button
                type="button"
                onclick="closePatientModal()"
                class="bg-gray-400 text-white px-4 py-2 rounded"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- APPOINTMENT MODAL -->
      <div
        id="appointmentModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"
      >
        <div class="bg-white p-6 rounded-xl w-96">
          <h2 id="appointmentModalTitle" class="text-xl font-bold mb-4">
            Edit Appointment
          </h2>
          <form id="appointmentForm">
            <input type="hidden" id="appointmentId" name="id" />

            <label class="block mb-2">Status</label>
            <select
              id="appointmentStatus"
              name="status"
              class="w-full border px-3 py-2 rounded mb-3"
            >
              <option value="PENDING">Pending</option>
              <option value="CONFIRMED">Confirmed</option>
              <option value="CANCELLED">Cancelled</option>
              <option value="COMPLETED">Completed</option>
              <option value="RESCHEDULED">Rescheduled</option>
            </select>

            <div class="flex justify-end gap-3">
              <button
                type="button"
                onclick="closeAppointmentModal()"
                class="px-4 py-2 bg-gray-400 text-white rounded"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-purple-600 text-white rounded"
              >
                Update
              </button>
              <button
                type="button"
                id="appointmentDeleteBtn"
                onclick="deleteAppointment()"
                class="px-4 py-2 bg-red-600 text-white rounded hidden"
              >
                Delete
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Tabs
      function showTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.add("hidden"));
        document.getElementById(tabId).classList.remove("hidden");
      }
      showTab("doctors"); // default

      // ---------- Doctor ----------
      function showDoctorModal(id) {
        const modal = document.getElementById("doctorModal");
        modal.classList.remove("hidden");

        const deleteBtn = document.getElementById("doctorDeleteBtn");

        if (id) {
          document.getElementById("doctorModalTitle").innerText = "Edit Doctor";
          deleteBtn.classList.remove("hidden");

          // Fetch existing doctor data
          fetch(`/api/admin/doctors/${id}`, {
            method: "GET",
    headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + localStorage.getItem("jwtToken") // or sessionStorage if you stored it there
    }
})

            .then((res) => res.json())
            .then((data) => {
              document.getElementById("doctorId").value = data.id || "";
              document.getElementById("doctorName").value = data.name || "";
              document.getElementById("doctorEmail").value = data.email || "";
              document.getElementById("doctorSpec").value =
                data.specialization || "";
            })
            .catch((err) => console.error("Fetch error:", err));
        } else {
          document.getElementById("doctorModalTitle").innerText = "Add Doctor";
          deleteBtn.classList.add("hidden");
          document.getElementById("doctorForm").reset();
          document.getElementById("doctorId").value = "";
        }
      }

      function closeDoctorModal() {
        document.getElementById("doctorModal").classList.add("hidden");
      }

      // ---------- Patient ----------
      function showPatientModal(id) {
        const modal = document.getElementById("patientModal");
        modal.classList.remove("hidden");

        const deleteBtn = document.getElementById("patientDeleteBtn");

        if (id) {
          document.getElementById("patientModalTitle").innerText =
            "Edit Patient";
          deleteBtn.classList.remove("hidden");

          // Fetch patient details
          fetch(`/api/admin/patients/${id}`)
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("patientId").value = data.id;
              document.getElementById("patientName").value = data.name;
              document.getElementById("patientEmail").value = data.email;
              document.getElementById("patientRole").value = data.role;
              document.getElementById("patientPassword").value = ""; // Blank by default
              document.getElementById("patientForm").action =
                "/api/admin/patients/" + id;
            })
            .catch((err) => console.error("Error fetching patient data:", err));

          // Handle delete
          deleteBtn.onclick = function () {
            if (confirm("Are you sure you want to delete this patient?")) {
              fetch(`/api/admin/patients/${id}`, {
                method: "DELETE",
              }).then(() => {
                closePatientModal();
                location.reload();
              });
            }
          };
        } else {
          document.getElementById("patientModalTitle").innerText =
            "Add Patient";
          deleteBtn.classList.add("hidden");
          document.getElementById("patientForm").reset();
          document.getElementById("patientForm").action = "/api/admin/patients";
          document.getElementById("patientId").value = "";
        }
      }

      function closePatientModal() {
        document.getElementById("patientModal").classList.add("hidden");
      }

      // ---------- Appointment ----------
      function showAppointmentModal(id) {
        const modal = document.getElementById("appointmentModal");
        modal.classList.remove("hidden");
        const deleteBtn = document.getElementById("appointmentDeleteBtn");

        fetch(`/api/admin/appointments/${id}`)
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("appointmentId").value = id;
            document.getElementById("appointmentStatus").value =
              data.status || "";
            deleteBtn.classList.remove("hidden");
          });
      }
      function closeAppointmentModal() {
        document.getElementById("appointmentModal").classList.add("hidden");
      }

      // ---------- Form Submissions ----------
      document
        .getElementById("doctorForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const id = document.getElementById("doctorId").value;

          const payload = {
            name: document.getElementById("doctorName").value,
            email: document.getElementById("doctorEmail").value,
            specialization: document.getElementById("doctorSpec").value,
          };
          fetch(id ? `/api/admin/doctors/${id}` : `/api/admin/doctors`, {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }).then(() => {
            closeDoctorModal();
            location.reload();
          });
        });

      document
        .getElementById("patientForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const id = document.getElementById("patientId").value;
          const payload = {
            name: document.getElementById("patientName").value,
            email: document.getElementById("patientEmail").value,
            role: document.getElementById("patientRole").value,
            password: document.getElementById("patientPassword").value || null,
          };
          fetch(id ? `/api/admin/patients/${id}` : `/api/admin/patients`, {
            method: id ? "PUT" : "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }).then(() => {
            closePatientModal();
            location.reload();
          });
        });

      document
        .getElementById("appointmentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const id = document.getElementById("appointmentId").value;
          const status = document.getElementById("appointmentStatus").value;

          fetch(`/api/admin/appointments/${id}/status?status=${status}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
          }).then(() => {
            closeAppointmentModal();
            location.reload();
          });
        });

      // ---------- Delete Functions ----------
      function deleteDoctor(id = document.getElementById("doctorId").value) {
        if (!id) return;
        if (confirm("Are you sure you want to delete this doctor?")) {
          fetch(`/api/admin/doctors/${id}`, { method: "DELETE" }).then(() => {
            closeDoctorModal();
            location.reload();
          });
        }
      }
      function deletePatient(id = document.getElementById("patientId").value) {
        if (!id) return;
        if (confirm("Are you sure you want to delete this patient?")) {
          fetch(`/api/admin/patients/${id}`, { method: "DELETE" }).then(() => {
            closePatientModal();
            location.reload();
          });
        }
      }
      function deleteAppointment(
        id = document.getElementById("appointmentId").value
      ) {
        if (!id) return;
        if (confirm("Are you sure you want to delete this appointment?")) {
          fetch(`/api/admin/appointments/${id}`, { method: "DELETE" }).then(
            () => {
              closeAppointmentModal();
              location.reload();
            }
          );
        }
      }
    </script>
  </body>
</html>
