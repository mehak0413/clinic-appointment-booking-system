<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:insert="~{fragments/head :: commonHead('Manage Prescriptions')}"></head>
<body class="bg-gray-100 min-h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-lg fixed left-0 top-0 h-full pt-20 z-0">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
  </aside>

  <!-- Main content -->
  <main class="flex-1 ml-64 p-8">
    <h1 class="text-2xl font-bold mb-4">Manage Prescriptions</h1>

    <!-- Create Prescription Form -->
    <form id="prescriptionForm" class="mb-6 bg-white p-6 rounded shadow-md">
      <input type="text" name="medication" placeholder="Medication" required class="border p-2 rounded w-full mb-2"/>
      <input type="text" name="dosage" placeholder="Dosage" required class="border p-2 rounded w-full mb-2"/>
      <input type="text" name="instructions" placeholder="Instructions" required class="border p-2 rounded w-full mb-2"/>
      <select name="appointmentId" required class="border p-2 rounded w-full mb-2">
  <option value="" disabled selected>Select Appointment</option>
  <option th:each="appt : ${appointments}"
          th:value="${appt.id}"
          th:text="${'Appointment ' + appt.id + ' - ' + appt.patientName}">
  </option>
</select>

      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Create Prescription</button>
    </form>

    <!-- Prescription List -->
    <h2 class="text-xl font-semibold mb-2">Prescription List</h2>
    <div id="prescriptions" class="bg-white p-6 rounded shadow-md"></div>
  </main>

  <!-- JS -->
  <script>
    document.getElementById("prescriptionForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target));

      const response = await fetch("/api/prescriptions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert("Prescription created!");
        loadPrescriptions();
      } else {
        alert("Error creating prescription");
      }
    });

    async function loadPrescriptions() {
      const response = await fetch("/api/prescriptions");
      if (!response.ok) {
        document.getElementById("prescriptions").innerText = "You don't have access to list prescriptions.";
        return;
      }
      const prescriptions = await response.json();
      let html = "<ul class='list-disc pl-6'>";
      prescriptions.forEach(p => {
        html += `<li>${p.medication} (${p.dosage}) - ${p.instructions}</li>`;
      });
      html += "</ul>";
      document.getElementById("prescriptions").innerHTML = html;
    }

    loadPrescriptions();
  </script>
</body>
</html>
